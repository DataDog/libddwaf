FROM alpine:3.12 AS toolchain
RUN true 1 && apk update && apk add build-base git cmake

FROM toolchain AS build
RUN mkdir /build
WORKDIR /build
COPY . /build/
RUN cmake -E make_directory build packages && \
    cd build && \
    cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=.. -DCPACK_PACKAGE_DIRECTORY=../packages .. && \
    cmake --build . --config RelWithDebInfo --verbose --target libddwaf_shared --target libddwaf_static --target testPowerWAF --target package -j
RUN cd tests && ../build/tests/testPowerWAF

FROM scratch
COPY --from=build /build/libddwaf/packages/ /packages/
COPY --from=build /build/include/ddwaf.h /build/include/
COPY --from=build /build/build/libddwaf.so /build/build/libddwaf.so.debug /build/build/libddwaf.a /build/lib/
COPY --from=build /build/build/CMakeFiles/Export/share/ /build/share/
CMD /bin/false
